# Gate 1 ガイド

このガイドでは、Chrome拡張機能プロジェクトに適用されたGate 1システムの使い方を説明します。

---

## 📋 Gate 1とは？

Gate 1は、「5歩進んだら7歩下がる」問題を解決するための構造化された開発プロセスです。

**主な目的:**
- 危険な変更を自動検知
- 影響範囲を明確化
- テストを必須化
- 問題の早期発見

---

## 🚀 使い方

### 1. ローカルでの使用

#### diff-check.shの実行

変更をコミットする前に、`diff-check.sh`を実行して危険な変更がないか確認します：

```bash
# Windows (Git BashまたはWSL)
bash scripts/diff-check.sh

# または、PowerShellから
bash scripts/diff-check.sh
```

**実行結果の見方:**
- ✅ **警告なし**: 安全にコミットできます
- ⚠️ **警告あり**: 必須アクションを実施してからコミットしてください

#### 警告が表示された場合

警告が表示された場合は、以下の手順を実施してください：

1. **manifest.jsonの変更**
   - Chrome拡張機能を再読み込み（`chrome://extensions/` → 更新ボタン）
   - 各機能を手動でテスト
   - コンソールでエラーを確認

2. **権限の変更**
   - 新しい権限が必要な理由を確認
   - セキュリティリスクを評価
   - Chrome Web Storeへの公開時に権限の説明が必要

3. **background.jsの変更**
   - Service Workerの動作確認
   - メッセージハンドリングのテスト
   - エラーハンドリングの確認

---

### 2. PR作成時の使用

PRを作成すると、自動的に`.github/pull_request_template.md`が表示されます。

**必須チェックリスト:**
- [ ] manifest.jsonを変更していない（または動作確認済み）
- [ ] 権限を変更していない（または評価済み）
- [ ] background.jsを変更していない（または動作確認済み）
- [ ] バージョン番号を更新した
- [ ] CHANGELOG.mdに変更内容を記載した
- [ ] diff-check.shを実行し、警告がないことを確認した
- [ ] Chrome拡張機能として再読み込みし、動作を確認した

**全てのチェックボックスにチェックを入れてからマージしてください。**

---

### 3. 新機能実装時の使用

新しい機能を実装する前に、`docs/contract.md`のテンプレートを使用して「4点セット」を記載します。

**4点セット:**
1. **目的（Why）**: なぜこの機能を実装するのか？
2. **やること（What）**: 何を実装するのか？
3. **やってはいけないこと（NG）**: 絶対に変更してはいけないファイル、機能
4. **Done条件（チェック可能）**: どうなったら完了とみなすか？

**使用例:**

```markdown
## Contract: サジェスト機能の追加

### 1. 目的（Why）
ユーザーが検索エンジンのサジェストを確認できるようにするため。

### 2. やること（What）
- [ ] Google Suggest APIの呼び出し機能を実装
- [ ] サジェスト結果をUIに表示する機能を実装

### 3. やってはいけないこと（NG）
- [ ] manifest.jsonの権限を追加しない
- [ ] background.jsの既存のメッセージハンドリングを変更しない

### 4. Done条件（チェック可能）
- [ ] diff-check.shを実行し、警告がない
- [ ] Chrome拡張機能として再読み込みし、動作を確認した
- [ ] バージョン番号を更新した
```

---

## 🔍 検知される危険な変更

Gate 1は以下の変更を検知します：

### 1. manifest.jsonの変更
- **影響範囲**: 拡張機能の設定、権限、バージョン
- **必須アクション**: 拡張機能の再読み込みと動作確認

### 2. 権限（permissions/host_permissions）の変更
- **影響範囲**: 拡張機能の権限、ユーザーへの権限要求
- **必須アクション**: 権限の必要性とセキュリティリスクの評価

### 3. background.jsの変更
- **影響範囲**: バックグラウンド処理、API呼び出し、メッセージハンドリング
- **必須アクション**: Service Workerの動作確認

### 4. popup.js/popup.htmlの変更
- **影響範囲**: UI表示、ユーザーインターフェース
- **必須アクション**: ポップアップの表示確認

### 5. バージョン番号の変更
- **確認事項**: バージョン番号が正しく更新されているか
- **推奨**: CHANGELOG.mdに変更内容を記載

---

## 📊 GitHub Actions CI

PRを作成すると、自動的にGitHub Actions CIが実行されます。

**CIで実行されるチェック:**
1. `diff-check.sh`の実行
2. `manifest.json`のバージョン番号確認
3. `manifest.json`のJSON形式検証
4. `CHANGELOG.md`の更新確認

**CIの結果:**
- ✅ **成功**: 全てのチェックが通過
- ⚠️ **警告**: 警告が表示されるが、マージは可能
- ❌ **失敗**: 必須のチェックが失敗（マージ不可）

---

## 🎯 ベストプラクティス

### 1. こまめなコミット
- 1つの変更ごとにコミット
- コミットメッセージは明確に
- バージョン番号を更新

### 2. テストの実施
- 変更後は必ず拡張機能を再読み込み
- 各機能を手動でテスト
- コンソールでエラーを確認

### 3. ドキュメントの更新
- 重要な変更は`CHANGELOG.md`に記載
- 新機能は`README.md`に記載
- 必要に応じて`docs/`に詳細を記載

### 4. PRの作成
- 小さな変更ごとにPRを作成
- Gate 1チェックリストを全てチェック
- スクリーンショットを添付（UI変更の場合）

---

## 🚨 トラブルシューティング

### diff-check.shが実行できない

**問題**: `bash: scripts/diff-check.sh: Permission denied`

**解決方法**:
```bash
chmod +x scripts/diff-check.sh
```

### Windowsでbashコマンドが使えない

**解決方法**:
1. Git Bashを使用
2. WSLを使用
3. GitHub Actions CIに依存（自動実行）

### CIが失敗する

**確認事項**:
1. `manifest.json`が有効なJSON形式か
2. バージョン番号が正しく設定されているか
3. `CHANGELOG.md`が更新されているか（重要な変更の場合）

---

## 📚 関連ドキュメント

- [PRテンプレート](../.github/pull_request_template.md)
- [Contractテンプレート](contract.md)
- [開発ガイド](guides/DEVELOPMENT_GUIDE.md)

---

## 🎉 まとめ

Gate 1を活用することで、以下のメリットが得られます：

1. **問題の早期発見**: 危険な変更を自動検知
2. **影響範囲の明確化**: 変更の影響を理解
3. **テストの必須化**: 動作確認を忘れない
4. **品質の向上**: 壊れた機能を防ぐ

「5歩進んだら7歩下がる」問題を解決し、安全に開発を進めましょう！
